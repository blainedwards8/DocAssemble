const $=(o,a,i=!1,s="")=>{if(!o)return"";let p=o.replace(/\{#foreach\s+([a-zA-Z0-9_-]+)\}([\s\S]*?)\{\/foreach\}/g,(d,t,r)=>{const n=a[t];if(!Array.isArray(n)||n.length===0)return i?"":`<div class="border-2 border-dashed border-amber-300 bg-amber-50 p-4 rounded-xl text-amber-700 italic text-sm my-4 flex items-center gap-2">
                List Variable {${t}} is empty.
            </div>`;const c=s?`${s}.${t}`:t;return n.map((l,f)=>$(r,l,i,`${c}[${f}]`)).join("")});const e=/\{([a-zA-Z0-9_-]+)(?:\|([a-zA-Z0-9_-]+))?(?:\[(.*?)\])?\}/g;return p.replace(e,(d,t,r,n)=>{const c=a[t]!==void 0&&a[t]!=="",l=`{${t}}`,f=c?a[t]:l,u=c?a[t]:l;if(i)return u;const b=s?`${s}.${t}`:t;return c?`<span data-variable="${b}" class="bg-emerald-50 hover:bg-emerald-100 cursor-pointer text-emerald-700 px-1 rounded font-bold border border-dashed border-emerald-300 font-mono text-[0.85em] transition-colors" title="Click to Edit">${f}</span>`:`<span data-variable="${b}" class="bg-amber-50 hover:bg-amber-100 cursor-pointer text-amber-700 px-1 rounded border border-dashed border-amber-300 font-mono text-[0.85em] font-bold transition-colors" title="Click to Edit">${f}</span>`})},y=(o,a=1,i=!1,s=[])=>{if(!o)return"";const p=o.split(`
`);let e=[],d=[];const t=r=>{for(;d.length>r;)e.push(`</${d.pop()}>`)};return p.forEach(r=>{const n=r.match(/^(#{1,3}) (.*$)/),c=r.match(/^(\s*)([0-9a-zA-Z]+|\*|-)[.)] (.*$)/);if(n){t(0);const l=n[1].length,f=n[2],u=l===1?"text-2xl font-black mt-6 mb-4 text-center border-b-2 pb-2":l===2?"text-xl font-bold mt-5 mb-3 border-b border-slate-100":"text-lg font-bold mt-4 mb-2 text-slate-700";e.push(`<h${l} class="${u}">${f}</h${l}>`)}else if(c){const l=c[1].length,f=Math.floor(l/2),u=!["*","-"].includes(c[2]),b=u?"ol":"ul";if(f<d.length-1&&t(f+1),f>=d.length){const g=f===0&&i?` start="${a}"`:"",h=u?s[f]||"decimal":"disc";e.push(`<${b}${g} class="list-${h} space-y-1 ml-6 mb-4" style="list-style-type: ${h}">`),d.push(b)}const m=c[3].replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");e.push(`<li class="pl-2 leading-relaxed">${m}</li>`)}else if(r.trim()==="")t(0);else{t(0);const l=r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");e.push(`<p class="mb-4 text-justify leading-relaxed">${l}</p>`)}}),t(0),e.join("")},x=async(o,a,i)=>{if(typeof window.showSaveFilePicker=="function")try{const t=await(await window.showSaveFilePicker({suggestedName:a,types:[{description:"File",accept:{[i]:[`.${a.split(".").pop()}`]}}]})).createWritable();await t.write(o),await t.close();return}catch(d){d.name!=="AbortError"&&console.error("Save failed",d)}const s=o instanceof Blob?o:new Blob([o],{type:i}),p=URL.createObjectURL(s),e=document.createElement("a");e.href=p,e.download=a,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(p)},v=(o,a)=>{if(!a)return;const i=a.split(/[\.\[\]]+/).filter(Boolean);let s=o;for(const p of i){if(s==null)return;s=s[p]}return s},A=(o,a,i)=>{const s=a.split(/[\.\[\]]+/).filter(Boolean),p=Array.isArray(o)?[...o]:{...o};let e=p;for(let t=0;t<s.length-1;t++){const r=s[t];if(e[r]===void 0){const n=!isNaN(s[t+1]);e[r]=n?[]:{}}Array.isArray(e[r])?e[r]=[...e[r]]:e[r]={...e[r]},e=e[r]}const d=s[s.length-1];return e[d]=i,p},w=o=>{if(!o)return{variables:[],sections:[],loops:[],variableMeta:{}};const a=new Set,i={},s=[],p=new Set;o.split(`
`).forEach(r=>{const n=r.match(/^\[\[([^|\]]+)(?:\|([^|\]]+))?.*\]\]$/);n&&s.push({level:1,title:n[1].trim(),category:n[2]?n[2].trim():null});const c=r.match(/\{#foreach\s+([a-zA-Z0-9_-]+)\}/);c&&p.add(c[1])});const d=/\{([a-zA-Z0-9_-]+)(?:\|([a-zA-Z0-9_-]+))?(?:\[(.*?)\])?\}/g,t=o.matchAll(d);for(const r of t){const n=r[1],c=r[2],l=r[3];a.add(n),(c||l)&&(i[n]={type:c||(l?"select":"text"),options:l?l.split(",").map(f=>f.trim()):void 0})}return{variables:Array.from(a).sort(),variableMeta:i,sections:s,loops:Array.from(p).sort()}};export{w as e,v as g,y as p,$ as r,A as s,x as t};
